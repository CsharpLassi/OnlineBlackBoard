{% extends 'blackboard/layout.html' %}
{% from 'form.html' import show_form %}

{% block css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='blackboard/main.css') }}">
{% endblock %}

{% block row %}
    <div class="row justify-content-center mt-3">
        <div class="col-6">
            <textarea id="board" class="form-control" style="width: 100%;height: 20em"></textarea>

        </div>
        <div class="col-6">
            {% include 'blackboard/content/contentElement.html' %}
        </div>

    </div>
    <div class="row justify-content-center mt-3">
        <div class="col-4">
            <div class="card">
                <div class="card-header">Clients</div>
                <div class="card-body">
                    <div id="userList">
                        {% for user_sid, user in  room.users.items() %}
                            <div id="user-{{ user.user_id }}">{{ user.username }}</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-8">
            <div class="card">
                <div class="card-header">Room Settings</div>
                <div class="card-body">
                    {{ show_form(edit_form,id='roomEdit') }}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block blackboard_js %}
    <script src="{{ url_for('static', filename='blackboard/user.js') }}"></script>

    <script>
        const canvas = document.querySelector('#contentSketchpad');
        $.sketchpad = new Atrament(canvas);

        $(document).on('socket:ready', function () {
            $.socket.on('room:draw:stroke', function (msg) {
                let stroke = msg.stroke
                // set drawing options
                $.sketchpad.mode = stroke.mode;
                $.sketchpad.weight = stroke.weight;
                $.sketchpad.smoothing = stroke.smoothing;
                $.sketchpad.color = stroke.color;
                $.sketchpad.adaptiveStroke = stroke.adaptiveStroke;

                // don't want to modify original data
                const points = stroke.points.slice();

                let firstPoint = points.shift();
                firstPoint.x *= $.sketchpad.width;
                firstPoint.y *= $.sketchpad.height;
                // beginStroke moves the "pen" to the given position and starts the path
                $.sketchpad.beginStroke(firstPoint.x, firstPoint.y);

                let prevPoint = firstPoint;
                while (points.length > 0) {
                    let point = points.shift();
                    point.x *= $.sketchpad.width;
                    point.y *= $.sketchpad.height;

                    // the `draw` method accepts the current real coordinates
                    // (i. e. actual cursor position), and the previous processed (filtered)
                    // position. It returns an object with the current processed position.
                    const {x, y} = $.sketchpad.draw(point.x, point.y, prevPoint.x, prevPoint.y);

                    // the processed position is the one where the line is actually drawn to
                    // so we have to store it and pass it to `draw` in the next step
                    prevPoint = {x, y};
                }

                // endStroke closes the path
                $.sketchpad.endStroke(prevPoint.x, prevPoint.y);
            });
        });
    </script>
{% endblock %}

